<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Welcome to the Coffee Club - My Balance</title>
		<style>
			body { font: 14px Helvetica, Arial; }
			#user { margin: 20px auto; text-align: center; }
			#photo { width: 100px; -webkit-clip-path: circle(50px); }
			#container { margin: 0 auto; text-align: center; }
			#statement { margin: 0 auto; padding: 0; border: 1px solid #ccc; border-collapse: collapse; width: 300px; }
			#statement td, #statement th { border: 1px solid #ccc; padding: 5px; }
			#statement:nth-child(0) { text-align: center; }
		</style>
	</head>
	<body>
		<user-photo signout-url="/index.html"></user-photo>
		<div id="container">
			<section id="whats-next">				
				<h3>Café dessa semana: <span id="next-coffee-name">Wolf (Alho poró) 250 KG</span></h3>
				<p><strong><a id="participate" href="#">Quero participar!</a></strong></p>				
				<img src="wolf_cafe.png" alt="Café Wolf (Alho poró)">
			</section>

			<h2>Seu saldo é: <span id="balance"></span></h2>
		
			<table id="statement">
				<thead>
					<tr><th colspan="3">Extrato</th></tr>
					<tr><th>Data</th><th>Valor R$</th><th>Descrição</th></tr>
				</thead>
				<tbody></tbody>
			</table>			
		</div>
	<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
	<script src="app.js"></script>
	<script>
		var participate = document.getElementById("participate");
		participate.addEventListener("click", (e) => {
			e.preventDefault();
			const dbRef = firebase.database().ref().child('next-coffee/participants');
			dbRef.push(firebase.auth().currentUser.displayName);
			alert('Obrigado! Você está participando do próximo café!');
		});

		function isParticipating(){
			const dbRef = firebase.database().ref().child('next-coffee/participants');
			const name = firebase.auth().currentUser.displayName;			
			dbRef.once('value', _ => {
				const values = _.val();
				const participants = Object.keys(values).map(k => values[k]);
				if (participants.indexOf(name) > -1) {
					var participate = document.getElementById("participate");
					participate.innerText = "Você está participando!";
				}
			});
		}

		function showNextCoffee() {
			const dbRef = firebase.database().ref().child('next-coffee');			
			dbRef.on('value', snap => {
				let cost = document.getElementById('cost');
				let expectedPrice = document.getElementById('cost');
				isParticipating();
			});
		}

		function clearTable(table) {
			let tbody = table.getElementsByTagName("tbody")[0];			
			let rows = tbody.children.length;
			for (let i = 0; i < rows; i++) {
				let row = tbody.children[i];
				tbody.deleteRow(row);
			};				
		}

		function createRowOnTable(table, ...columnValues) {
			var tbody = table.getElementsByTagName("tbody")[0];
			var tr = document.createElement('tr');
			columnValues.forEach(columnValue => {
				var td = document.createElement('td');
				td.innerText = columnValue || "";
				tr.appendChild(td);
			});
			tbody.appendChild(tr);
		}

		function loadBalance(displayName) {
			const usernode ='statement/' + displayName;	
			var dbRef = firebase.database().ref().child(usernode);
			let statement = document.getElementById('statement');
			dbRef.on('value', snap => {
				let balance = 0;
				clearTable(statement);
				snap.forEach(_ => {
					var val = _.val();
					createRowOnTable(statement, val.date.replace('-', '/'), val.value.toFixed(2), val.description);					
					balance += _.val().value;
				});
				let balanceElement = document.getElementById('balance');
				balanceElement.innerText = "R$ " + balance.toFixed(2);
			});
		}
	</script>
</body>
</html>