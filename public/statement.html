<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Welcome to the Coffee Club - My Balance</title>
		<style>
			body { font: 14px Helvetica, Arial; }
			#user { margin: 20px auto; text-align: center; }
			#photo { width: 100px; -webkit-clip-path: circle(50px); }
			#container { margin: 0 auto; text-align: center; }
			#statement { margin: 0 auto; padding: 0; border: 1px solid #ccc; border-collapse: collapse; width: 300px; }
			#statement td, #statement th { border: 1px solid #ccc; padding: 5px; }
			#statement:nth-child(0) { text-align: center; }
		</style>
	</head>
	<body>
		<section id="user">
			<img id="photo" />
			<div><a id="logout" href="#">Sair</a></div>
		</section>
		<div id="container">
			<section id="whats-next">
				<h3>Próximo café: <span id="next-coffee-name">Café Fazenda São João 1KG (Previsão de entrega: 14/10)</span></h3>
				<p><strong><a id="participate" href="#">Quero participar!</a></strong></p>
				<img src="https://cdn.awsli.com.br/400x400/100/100625/produto/3491247/4e8aedd215.jpg" alt="Café da Fazenda São João">				
			</section>

			<h2>Seu saldo é: <span id="balance"></span></h2>
		
			<table id="statement">
				<thead>
					<tr><th colspan="3">Extrato</th></tr>
					<tr><th>Data</th><th>Valor R$</th><th>Descrição</th></tr>
				</thead>
				<tbody></tbody>
			</table>			
		</div>
	<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
	<script src="app.js"></script>
	<script>
		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				var name, email, photoUrl, uid;
					name = user.displayName;
					email = user.email;
					photoUrl = user.photoURL;
					uid = user.uid;  // The user's ID, unique to the Firebase project. Do NOT use
					// this value to authenticate with your backend server, if
					// you have one. Use User.getToken() instead.
					var photo = document.getElementById("photo");
					photo.src = photoUrl;

					showNextCoffee();
					loadBalance(name);					
			} else {
				location.href = "index.html"
			}
		});
		
		var logout = document.getElementById("logout");
		logout.addEventListener("click", () => {
			firebase.auth().signOut().then(function() {
				console.log('User logged out');
			}, function(error) {
			// An error happened.
			});
		});

		var participate = document.getElementById("participate");
		participate.addEventListener("click", (e) => {
			e.preventDefault();
			const dbRef = firebase.database().ref().child('next-coffee/participants');
			dbRef.push(firebase.auth().currentUser.displayName);
			alert('Obrigado! Você está participando do próximo café!');
		});

		function showNextCoffee() {
			const dbRef = firebase.database().ref().child('next-coffee');			
			dbRef.on('value', snap => {
				let cost = document.getElementById('cost');
				let expectedPrice = document.getElementById('cost');
			});
		}

		function clearTable(table) {
			let tbody = table.getElementsByTagName("tbody")[0];			
			let rows = tbody.children.length;
			for (let i = 0; i < rows; i++) {
				let row = tbody.children[i];
				tbody.deleteRow(row);
			};				
		}

		function createRowOnTable(table, ...columnValues) {
			var tbody = table.getElementsByTagName("tbody")[0];
			var tr = document.createElement('tr');
			columnValues.forEach(columnValue => {
				var td = document.createElement('td');
				td.innerText = columnValue || "";
				tr.appendChild(td);
			});
			tbody.appendChild(tr);
		}

		function loadBalance(displayName) {
			const usernode ='statement/' + displayName;	
			var dbRef = firebase.database().ref().child(usernode);
			let statement = document.getElementById('statement');
			dbRef.on('value', snap => {
				let balance = 0;
				clearTable(statement);
				snap.forEach(_ => {
					var val = _.val();
					createRowOnTable(statement, val.date.replace('-', '/'), val.value, val.description);					
					balance += _.val().value;
				});
				let balanceElement = document.getElementById('balance');
				balanceElement.innerText = "R$ " + balance;
			});
		}
	</script>
</body>
</html>