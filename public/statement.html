<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Welcome to the Coffee Club - My Balance</title>
	<style>
		body { font: 14px Helvetica, Arial; }
		#user { margin: 20px auto; text-align: center; }
		#photo { width: 100px; -webkit-clip-path: circle(50px); }
		#container { margin: 0 auto; text-align: center; }
		#statement { list-style: none; margin: 0; padding: 0; }
	</style>
</head>
<body>
	<section id="user">
		<img id="photo"></img>
		<div><a id="logout" href="#">Sair</a></div>
	</section>

	<div id="container">
		<h2>Saldo: <span id="balance"></span></h2>
		Extrato: <ol id="statement"></ol>
	</div>

	<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
	<script src="app.js"></script>
	<script>
		firebase.auth().onAuthStateChanged(function(user) {
		  if (user) {
		    var name, email, photoUrl, uid;

			  name = user.displayName;
			  email = user.email;
			  photoUrl = user.photoURL;
			  uid = user.uid;  // The user's ID, unique to the Firebase project. Do NOT use
			                   // this value to authenticate with your backend server, if
			                   // you have one. Use User.getToken() instead.

			  var photo = document.getElementById("photo");
			  photo.src = photoUrl;

			  var displayName = document.getElementById("displayName");
			  displayName.innerText = name;

			  loadBalance(displayName);
		  } else {
		    location.href = "index.html"
		  }
		});

	var logout = document.getElementById("logout");
	logout.addEventListener("click", () => {
		firebase.auth().signOut().then(function() {
		  console.log('User logged out');
		}, function(error) {
		  // An error happened.
		});
	});

	function loadBalance(displayName) {
	  let balance = 0;
	  var dbRef = firebase.database().ref().child('statement/' + displayName);	  
	  let statement = document.getElementById('statement');
	  dbRef.on('value', snap => {
	  	snap.forEach(_ => {	  	
		  	var li = document.createElement('li');
		  	li.innerText = `Data: ${_.val().date} - Valor: ${_.val().value}`;
		  	statement.appendChild(li);
		  	balance += _.val().value;	  
	    });
	    let balanceElement = document.getElementById('balance');
	    balanceElement.innerText = "R$ " + balance;
	  });
	}
	</script>
</body>
</html>